<!DOCTYPE html>
<html lang="hu">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard ‚Äì Party Map</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="style.css" />
    <link rel="icon" type="image/png" href="img/partymap.png">
  </head>
  <body class="bg-[#0a0a0a] text-white min-h-screen">
    <nav class="fixed top-0 left-0 right-0 z-50 bg-black/30 backdrop-blur-md border-b border-white/10">
      <div class="max-w-7xl mx-auto px-3 sm:px-4 h-12 sm:h-14 flex items-center justify-between">
        <a href="index.html" class="font-bold text-[#a855f7] drop-shadow-[0_0_8px_#a855f7]"><img src="img/partymapfeher.png" alt="Party Map" class="w-16 sm:w-20 h-auto"></a>
        <div class="flex items-center gap-2 sm:gap-4 text-xs sm:text-sm">
          <a class="hover:text-[#a855f7] whitespace-nowrap" href="map.html">T√©rk√©p</a>
          <a class="hover:text-[#a855f7] whitespace-nowrap hidden sm:inline" href="index.html">Kezd≈ëlap</a>
          <button id="logout-btn" class="hover:text-[#a855f7] text-red-400 whitespace-nowrap text-xs sm:text-sm">Kijelentkez√©s</button>
        </div>
      </div>
    </nav>

    <main class="pt-16 sm:pt-20 pb-6 sm:pb-8 px-4 sm:px-6 max-w-7xl mx-auto">
      <div id="bg-dots" class="pointer-events-none fixed inset-0 opacity-20"></div>
      
      <h1 class="text-2xl sm:text-3xl font-bold mb-4 sm:mb-6 text-[#a855f7]">Dashboard</h1>

      <!-- Grid layout: Profil + Hazibuli hozz√°ad√°sa -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-6 mb-4 sm:mb-6">
        <!-- Profil inform√°ci√≥k -->
        <div class="bg-white/5 backdrop-blur-md border border-white/10 rounded-xl sm:rounded-2xl p-4 sm:p-6 glass-panel">
          <h2 class="text-lg sm:text-xl font-semibold mb-3 sm:mb-4 text-[#a855f7]">Profil adatok</h2>
          <form id="profile-form" class="space-y-4">
            <div>
              <label for="profile-name" class="text-sm block mb-1">N√©v</label>
              <input id="profile-name" type="text" placeholder="Add meg a neved" class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#a855f7]" />
            </div>
            <div>
              <label for="profile-email" class="text-sm block mb-1">E-mail</label>
              <input id="profile-email" type="email" disabled class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white/50" />
            </div>
            <button type="submit" class="w-full cta-primary text-white rounded-lg py-2 hover:shadow-[0_0_20px_#a855f7] transition">Ment√©s</button>
            <p id="profile-success" class="text-emerald-400 text-sm hidden text-center">‚úì Profil sikeresen friss√≠tve!</p>
          </form>
        </div>

        <!-- Hazibuli hozz√°ad√°sa -->
        <div class="lg:col-span-2 bg-white/5 backdrop-blur-md border border-white/10 rounded-xl sm:rounded-2xl p-4 sm:p-6 glass-panel">
          <h2 class="text-lg sm:text-xl font-semibold mb-3 sm:mb-4 text-[#a855f7]">üéâ √öj hazibuli hozz√°ad√°sa</h2>
          <form id="event-form" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="event-name" class="text-sm block mb-1">Buli neve</label>
                <input id="event-name" type="text" required placeholder="Pl. Sz√ºlet√©snapoz√°s" class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#a855f7]" />
              </div>
              <div>
                <label for="event-date" class="text-sm block mb-1">D√°tum</label>
                <input id="event-date" type="datetime-local" class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#a855f7]" />
              </div>
            </div>
            <div>
              <label for="event-address" class="text-sm block mb-1">C√≠m</label>
              <input id="event-address" type="text" placeholder="C√≠m vagy hely" class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#a855f7]" />
            </div>
            <div>
              <label for="event-description" class="text-sm block mb-1">Le√≠r√°s</label>
              <textarea id="event-description" rows="3" placeholder="√çrj le n√©h√°ny mondatot az esem√©nyr≈ël..." class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#a855f7] resize-y"></textarea>
            </div>
            <div class="bg-white/5 rounded-lg p-3 border border-white/10">
              <p class="text-xs text-white/70 mb-2">üìç Poz√≠ci√≥ kiv√°laszt√°sa a t√©rk√©pen</p>
              <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2 mb-2">
                <button type="button" id="open-map-btn" class="w-full sm:w-auto px-4 py-2 bg-[#a855f7]/20 hover:bg-[#a855f7]/30 border border-[#a855f7]/40 rounded-lg text-xs sm:text-sm text-[#a855f7] transition">
                  T√©rk√©p megnyit√°sa
                </button>
                <span id="event-coords" class="text-xs text-white/60 break-words sm:break-normal">Koordin√°t√°k: nincs be√°ll√≠tva</span>
              </div>
              <p class="text-xs text-white/50">A t√©rk√©pen kattints a helyre, majd t√©rj vissza √©s hozz√°ad√°s.</p>
            </div>
            <button type="submit" class="w-full cta-primary text-white rounded-lg py-2 hover:shadow-[0_0_20px_#a855f7] transition">Hazibuli hozz√°ad√°sa</button>
            <p id="event-success" class="text-emerald-400 text-sm hidden text-center">‚úì Hazibuli sikeresen hozz√°adva!</p>
          </form>
        </div>
      </div>

      <!-- Hazibulijaim szekci√≥ -->
      <div class="bg-white/5 backdrop-blur-md border border-white/10 rounded-xl sm:rounded-2xl p-4 sm:p-6 glass-panel">
        <h2 class="text-lg sm:text-xl font-semibold mb-3 sm:mb-4 text-[#a855f7]">Hazibulijaim</h2>
        <div id="my-events-list" class="space-y-3">
          <div class="text-white/60 text-center py-8">M√©g nincs hazibuli hozz√°adva.</div>
        </div>
      </div>
    </main>

    <!-- Hazibuli szerkeszt√©se modal -->
    <div id="edit-event-modal" class="hidden fixed inset-0 z-[3000]">
      <div class="absolute inset-0 bg-black/60" id="edit-event-modal-backdrop"></div>
      <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-[90vw] max-w-md bg-white/10 backdrop-blur-xl border border-white/20 rounded-2xl p-4 sm:p-6 shadow-[0_0_30px_#a855f7] max-h-[90vh] overflow-y-auto">
        <h3 class="text-xl font-semibold mb-4 text-[#a855f7]">Hazibuli szerkeszt√©se</h3>
        <form id="edit-event-form" class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="edit-event-name" class="text-sm block mb-1">Buli neve</label>
              <input id="edit-event-name" type="text" required placeholder="Pl. Sz√ºlet√©snapoz√°s" class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#a855f7]" />
            </div>
            <div>
              <label for="edit-event-date" class="text-sm block mb-1">D√°tum</label>
              <input id="edit-event-date" type="datetime-local" class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#a855f7]" />
            </div>
          </div>
          <div>
            <label for="edit-event-address" class="text-sm block mb-1">C√≠m</label>
            <input id="edit-event-address" type="text" placeholder="C√≠m vagy hely" class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#a855f7]" />
          </div>
          <div>
            <label for="edit-event-description" class="text-sm block mb-1">Le√≠r√°s</label>
            <textarea id="edit-event-description" rows="3" placeholder="√çrj le n√©h√°ny mondatot az esem√©nyr≈ël..." class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#a855f7] resize-y"></textarea>
          </div>
          <div class="bg-white/5 rounded-lg p-3 border border-white/10">
            <p class="text-xs text-white/70 mb-2">üìç Poz√≠ci√≥ m√≥dos√≠t√°sa</p>
            <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2 mb-2">
              <button type="button" id="edit-open-map-btn" class="w-full sm:w-auto px-4 py-2 bg-[#a855f7]/20 hover:bg-[#a855f7]/30 border border-[#a855f7]/40 rounded-lg text-xs sm:text-sm text-[#a855f7] transition">
                √öj poz√≠ci√≥ kiv√°laszt√°sa
              </button>
              <span id="edit-event-coords" class="text-xs text-white/60 break-words sm:break-normal">Koordin√°t√°k: nem v√°ltozott</span>
            </div>
            <p class="text-xs text-white/50">A t√©rk√©pen kattints a helyre, majd t√©rj vissza.</p>
          </div>
          <input type="hidden" id="edit-event-index" />
          <div class="flex gap-2">
            <button type="submit" class="flex-1 cta-primary text-white rounded-lg py-2 hover:shadow-[0_0_20px_#a855f7] transition">Ment√©s</button>
            <button type="button" id="edit-event-cancel" class="flex-1 bg-white/5 hover:bg-white/10 text-white rounded-lg py-2 border border-white/10">M√©gse</button>
          </div>
        </form>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="script.js"></script>
    <script>
      // Profil bet√∂lt√©se
      const session = readSession();
      if (!session) {
        window.location.href = 'login.html';
      }

      const profileForm = document.getElementById('profile-form');
      const profileName = document.getElementById('profile-name');
      const profileEmail = document.getElementById('profile-email');
      const logoutBtn = document.getElementById('logout-btn');
      let selectedEventCoords = null;

      // Profil adatok bet√∂lt√©se
      const PROFILE_KEY = 'dma_profile_' + session.email;
      const profileData = JSON.parse(localStorage.getItem(PROFILE_KEY) || '{}');
      
      profileName.value = profileData.name || '';
      profileEmail.value = session.email;

      // Profil ment√©se
      profileForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const name = profileName.value.trim();
        localStorage.setItem(PROFILE_KEY, JSON.stringify({ name }));
        const successEl = document.getElementById('profile-success');
        successEl.classList.remove('hidden');
        setTimeout(() => {
          successEl.classList.add('hidden');
        }, 3000);
      });

      // Kijelentkez√©s
      logoutBtn.addEventListener('click', () => {
        localStorage.removeItem('dma_session');
        window.location.href = 'index.html';
      });

      // Poz√≠ci√≥ bet√∂lt√©se localStorage-b√≥l (ha a t√©rk√©pr≈ël j√∂tt√ºnk)
      async function loadSelectedCoords() {
        const coords = localStorage.getItem('selected-event-coords');
        if (coords) {
          try {
            selectedEventCoords = JSON.parse(coords);
            const [lat, lng] = selectedEventCoords;
            document.getElementById('event-coords').textContent = `Koordin√°t√°k: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            localStorage.removeItem('selected-event-coords');
            
            // Ha van elmentett form adat, bet√∂ltj√ºk √©s automatikusan elmentj√ºk a hazibulit
            const pendingFormData = localStorage.getItem('pending-event-form');
            if (pendingFormData) {
              try {
                const formData = JSON.parse(pendingFormData);
                // Form mez≈ëk kit√∂lt√©se
                document.getElementById('event-name').value = formData.name || '';
                document.getElementById('event-address').value = formData.address || '';
                document.getElementById('event-description').value = formData.description || '';
                document.getElementById('event-date').value = formData.date || '';
                
                // Automatikusan elmentj√ºk a hazibulit
                const profile = JSON.parse(localStorage.getItem(PROFILE_KEY) || '{}');
                const eventData = {
                  name: formData.name,
                  address: formData.address,
                  description: formData.description,
                  date: formData.date,
                  coordinates: selectedEventCoords,
                  creator: session.email,
                  creatorName: profile.name || session.email,
                  createdAt: new Date().toISOString(),
                };

                // Bet√∂ltj√ºk a megl√©v≈ë eventeket
                let events = [];
                try {
                  const tempEvents = localStorage.getItem('user-events-temp');
                  if (tempEvents) {
                    events = JSON.parse(tempEvents);
                  } else {
                    const res = await fetch('./user-events.json');
                    events = await res.json();
                  }
                } catch (e) {
                  console.error('Eventek bet√∂lt√©se sikertelen', e);
                }

                events.push(eventData);
                localStorage.setItem('user-events-temp', JSON.stringify(events));
                
                // T√∂r√∂lj√ºk a pending form adatokat
                localStorage.removeItem('pending-event-form');
                
                // Form reset
                document.getElementById('event-form').reset();
                selectedEventCoords = null;
                document.getElementById('event-coords').textContent = 'Koordin√°t√°k: nem be√°ll√≠tva';
                
                // Lista friss√≠t√©se
                loadMyEvents();
                
                // Sikeres √ºzenet
                const successEl = document.getElementById('event-success');
                if (successEl) {
                  successEl.textContent = '‚úì Hazibuli sikeresen hozz√°adva!';
                  successEl.classList.remove('hidden');
                  setTimeout(() => {
                    successEl.classList.add('hidden');
                  }, 3000);
                }
              } catch (e) {
                console.error('Form adatok bet√∂lt√©se sikertelen', e);
                localStorage.removeItem('pending-event-form');
              }
            }
          } catch (e) {
            console.error('Koordin√°t√°k bet√∂lt√©se sikertelen', e);
          }
        }
      }

      // T√©rk√©p megnyit√°sa gomb
      const openMapBtn = document.getElementById('open-map-btn');
      if (openMapBtn) {
        openMapBtn.addEventListener('click', () => {
          // Elmentj√ºk a form adatokat, ha vannak (koordin√°ta hi√°ny√°ban)
          if (!selectedEventCoords) {
            const formData = {
              name: document.getElementById('event-name').value.trim(),
              address: document.getElementById('event-address').value.trim() || '',
              description: document.getElementById('event-description').value.trim() || '',
              date: document.getElementById('event-date').value || '',
            };
            // Csak akkor mentj√ºk, ha van legal√°bb n√©v
            if (formData.name) {
              localStorage.setItem('pending-event-form', JSON.stringify(formData));
            }
          }
          // Elmentj√ºk hogy t√©rk√©pr≈ël j√∂v√ºnk
          localStorage.setItem('return-to-profile', 'true');
          window.location.href = 'map.html';
        });
      }

      // Hazibulik list√°z√°sa
      async function loadMyEvents() {
        let events = [];
        try {
          const tempEvents = localStorage.getItem('user-events-temp');
          if (tempEvents) {
            events = JSON.parse(tempEvents);
          } else {
            const res = await fetch('./user-events.json');
            events = await res.json();
          }
        } catch (e) {
          console.error('Hazibulik bet√∂lt√©se sikertelen', e);
        }
        
        const myEvents = events.filter(e => e.creator === session.email);
        const listEl = document.getElementById('my-events-list');
        
        if (myEvents.length === 0) {
          listEl.innerHTML = '<div class="text-white/60 text-center py-8">M√©g nincs hazibuli hozz√°adva.</div>';
          return;
        }

        listEl.innerHTML = myEvents.map((event, index) => `
          <div class="bg-white/5 rounded-lg p-3 sm:p-4 border border-white/10 hover:border-[#a855f7]/40 transition">
            <div class="flex items-start justify-between gap-2 sm:gap-4">
              <div class="flex-1 min-w-0">
                <div class="font-semibold text-base sm:text-lg mb-1 sm:mb-2 truncate">üéâ ${event.name}</div>
                <div class="text-xs sm:text-sm text-white/70 space-y-1">
                  ${event.address ? `<div class="break-words">üìç ${event.address}</div>` : ''}
                  ${event.date ? `<div>üìÖ ${new Date(event.date).toLocaleString('hu-HU')}</div>` : ''}
                  ${event.description ? `<div class="text-white/80 mt-1 break-words">${event.description}</div>` : ''}
                  ${event.coordinates ? `<div class="text-xs text-white/50 break-all sm:break-normal">Koordin√°t√°k: ${event.coordinates[0].toFixed(4)}, ${event.coordinates[1].toFixed(4)}</div>` : ''}
                </div>
              </div>
              <div class="flex flex-col gap-2 shrink-0">
                <button class="edit-event-btn px-3 py-1.5 bg-[#a855f7]/20 hover:bg-[#a855f7]/30 border border-[#a855f7]/40 rounded-lg text-xs sm:text-sm text-[#a855f7] transition" data-index="${index}">
                  ‚úèÔ∏è Szerkeszt√©s
                </button>
                <button class="delete-event-btn px-3 py-1.5 bg-red-500/20 hover:bg-red-500/30 border border-red-500/40 rounded-lg text-xs sm:text-sm text-red-400 transition" data-index="${index}">
                  üóëÔ∏è T√∂rl√©s
                </button>
              </div>
            </div>
          </div>
        `).join('');

        // Szerkeszt√©s gombok
        listEl.querySelectorAll('.edit-event-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const index = parseInt(btn.dataset.index);
            openEditModal(index);
          });
        });

        // T√∂rl√©s gombok
        listEl.querySelectorAll('.delete-event-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const index = parseInt(btn.dataset.index);
            if (confirm('Biztosan t√∂r√∂lni szeretn√©d ezt a hazibulit?')) {
              deleteEvent(index);
            }
          });
        });
      }

      // Hazibuli form submit
      const eventForm = document.getElementById('event-form');
      if (eventForm) {
        eventForm.addEventListener('submit', async (e) => {
          e.preventDefault();

          if (!selectedEventCoords) {
            alert('K√©rlek v√°lassz ki egy poz√≠ci√≥t a t√©rk√©pen!');
            return;
          }

          const profile = JSON.parse(localStorage.getItem(PROFILE_KEY) || '{}');
          const eventData = {
            name: document.getElementById('event-name').value.trim(),
            address: document.getElementById('event-address').value.trim() || '',
            description: document.getElementById('event-description').value.trim() || '',
            date: document.getElementById('event-date').value || '',
            coordinates: selectedEventCoords,
            creator: session.email,
            creatorName: profile.name || session.email,
            createdAt: new Date().toISOString(),
          };

          // Bet√∂ltj√ºk a megl√©v≈ë eventeket
          let events = [];
          try {
            const tempEvents = localStorage.getItem('user-events-temp');
            if (tempEvents) {
              events = JSON.parse(tempEvents);
            } else {
              const res = await fetch('./user-events.json');
              events = await res.json();
            }
          } catch (e) {
            console.error('Eventek bet√∂lt√©se sikertelen', e);
          }

          events.push(eventData);
          localStorage.setItem('user-events-temp', JSON.stringify(events));
          
          // T√∂r√∂lj√ºk a pending form adatokat, ha vannak
          localStorage.removeItem('pending-event-form');

          // Form reset √©s koordin√°t√°k t√∂rl√©se
          eventForm.reset();
          selectedEventCoords = null;
          document.getElementById('event-coords').textContent = 'Koordin√°t√°k: nem be√°ll√≠tva';

          const successEl = document.getElementById('event-success');
          successEl.classList.remove('hidden');
          setTimeout(() => {
            successEl.classList.add('hidden');
          }, 3000);

          // Lista friss√≠t√©se
          loadMyEvents();
        });
      }

      // Szerkeszt√©si modal kezel√©se
      let allEvents = [];
      let editingEventIndex = null;
      let editingEventCoords = null;

      const editModal = document.getElementById('edit-event-modal');
      const editForm = document.getElementById('edit-event-form');
      const editCancel = document.getElementById('edit-event-cancel');
      const editOpenMapBtn = document.getElementById('edit-open-map-btn');

      function openEditModal(index) {
        async function loadMyEvents() {
          let events = [];
          try {
            const tempEvents = localStorage.getItem('user-events-temp');
            if (tempEvents) {
              events = JSON.parse(tempEvents);
            } else {
              const res = await fetch('./user-events.json');
              events = await res.json();
            }
          } catch (e) {
            console.error('Eventek bet√∂lt√©se sikertelen', e);
          }
          return events.filter(e => e.creator === session.email);
        }

        (async () => {
          const myEvents = await loadMyEvents();
          const event = myEvents[index];
          if (!event) return;

          editingEventIndex = index;
          editingEventCoords = event.coordinates || null;

          document.getElementById('edit-event-name').value = event.name || '';
          document.getElementById('edit-event-address').value = event.address || '';
          document.getElementById('edit-event-description').value = event.description || '';
          document.getElementById('edit-event-date').value = event.date ? new Date(event.date).toISOString().slice(0, 16) : '';
          document.getElementById('edit-event-index').value = index;
          document.getElementById('edit-event-coords').textContent = event.coordinates 
            ? `Koordin√°t√°k: ${event.coordinates[0].toFixed(6)}, ${event.coordinates[1].toFixed(6)}`
            : 'Koordin√°t√°k: nem v√°ltozott';

          editModal.classList.remove('hidden');
        })();
      }

      function closeEditModal() {
        editModal.classList.add('hidden');
        editingEventIndex = null;
        editingEventCoords = null;
        editForm.reset();
      }

      if (editCancel) {
        editCancel.addEventListener('click', closeEditModal);
      }

      if (editModal) {
        const backdrop = editModal.querySelector('#edit-event-modal-backdrop');
        if (backdrop) {
          backdrop.addEventListener('click', closeEditModal);
        }
      }

      if (editOpenMapBtn) {
        editOpenMapBtn.addEventListener('click', () => {
          localStorage.setItem('return-to-profile', 'true');
          localStorage.setItem('edit-event-mode', 'true');
          localStorage.setItem('edit-event-index', editingEventIndex);
          window.location.href = 'map.html';
        });
      }

      // Szerkeszt√©si koordin√°t√°k bet√∂lt√©se
      function loadEditSelectedCoords() {
        const editMode = localStorage.getItem('edit-event-mode');
        if (editMode) {
          const coords = localStorage.getItem('selected-event-coords');
          if (coords) {
            try {
              editingEventCoords = JSON.parse(coords);
              const [lat, lng] = editingEventCoords;
              document.getElementById('edit-event-coords').textContent = `Koordin√°t√°k: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
              localStorage.removeItem('selected-event-coords');
              localStorage.removeItem('edit-event-mode');
            } catch (e) {
              console.error('Koordin√°t√°k bet√∂lt√©se sikertelen', e);
            }
          }
        }
      }

      if (editForm) {
        editForm.addEventListener('submit', async (e) => {
          e.preventDefault();

          const index = parseInt(document.getElementById('edit-event-index').value);
          
          async function loadAllEvents() {
            let events = [];
            try {
              const tempEvents = localStorage.getItem('user-events-temp');
              if (tempEvents) {
                events = JSON.parse(tempEvents);
              } else {
                const res = await fetch('./user-events.json');
                events = await res.json();
              }
            } catch (e) {
              console.error('Eventek bet√∂lt√©se sikertelen', e);
            }
            return events;
          }

          const allEvents = await loadAllEvents();
          const myEvents = allEvents.filter(e => e.creator === session.email);
          
          if (index >= 0 && index < myEvents.length) {
            // Megkeress√ºk az eredeti eventet az allEvents t√∂mbben
            const originalEvent = myEvents[index];
            const originalIndex = allEvents.findIndex(e => 
              e.creator === originalEvent.creator &&
              e.name === originalEvent.name &&
              e.coordinates && originalEvent.coordinates &&
              e.coordinates[0] === originalEvent.coordinates[0] &&
              e.coordinates[1] === originalEvent.coordinates[1]
            );

            if (originalIndex !== -1) {
              const profile = JSON.parse(localStorage.getItem(PROFILE_KEY) || '{}');
              
              allEvents[originalIndex] = {
                ...allEvents[originalIndex],
                name: document.getElementById('edit-event-name').value.trim(),
                address: document.getElementById('edit-event-address').value.trim() || '',
                description: document.getElementById('edit-event-description').value.trim() || '',
                date: document.getElementById('edit-event-date').value || '',
                coordinates: editingEventCoords || allEvents[originalIndex].coordinates,
                creatorName: profile.name || session.email,
              };

              localStorage.setItem('user-events-temp', JSON.stringify(allEvents));
              
              closeEditModal();
              loadMyEvents();
              
              const successEl = document.getElementById('event-success');
              if (successEl) {
                successEl.textContent = '‚úì Hazibuli sikeresen m√≥dos√≠tva!';
                successEl.classList.remove('hidden');
                setTimeout(() => {
                  successEl.classList.add('hidden');
                }, 3000);
              }
            }
          }
        });
      }

      async function deleteEvent(index) {
        async function loadAllEvents() {
          let events = [];
          try {
            const tempEvents = localStorage.getItem('user-events-temp');
            if (tempEvents) {
              events = JSON.parse(tempEvents);
            } else {
              const res = await fetch('./user-events.json');
              events = await res.json();
            }
          } catch (e) {
            console.error('Eventek bet√∂lt√©se sikertelen', e);
          }
          return events;
        }

        const allEvents = await loadAllEvents();
        const myEvents = allEvents.filter(e => e.creator === session.email);
        
        if (index >= 0 && index < myEvents.length) {
          const eventToDelete = myEvents[index];
          const deleteIndex = allEvents.findIndex(e => 
            e.creator === eventToDelete.creator &&
            e.name === eventToDelete.name &&
            e.coordinates && eventToDelete.coordinates &&
            e.coordinates[0] === eventToDelete.coordinates[0] &&
            e.coordinates[1] === eventToDelete.coordinates[1]
          );

          if (deleteIndex !== -1) {
            allEvents.splice(deleteIndex, 1);
            localStorage.setItem('user-events-temp', JSON.stringify(allEvents));
            loadMyEvents();
          }
        }
      }

      // Koordin√°t√°k bet√∂lt√©se oldal bet√∂lt√©sekor
      loadSelectedCoords();
      loadEditSelectedCoords();
      loadMyEvents();
    </script>
  </body>
</html>
